# Use Case Example
This is an example of a use case for creating load in a Kubernetes cluster. For all of these tools, a single Docker image is created. Using this Docker image, however, multiple pods are created to perform specific functions.

## Synthetic Data Production and Processing (SDP2) Pipeline
### Framework Design
<img src="./images/design.svg">

### Framework Implementation
```shell
 ----------------------------------------------------------------------------------
|                           Kubernetes Cluster                                     |
 ----------------------------------------------------------------------------------
|  ------------------------------------------------------------------------------  |
| |                             K8S Master                                       | |
|  ------------------------------------------------------------------------------  |
| --------------           ------------------------------------------------------- |
|| K8S Worker-1 |         |                     K8S Worker-2                     | |          
| --------------          |------------------------------------------------------| |         
||   --------   |    2    |  -----------    3     -------                        | |      
||  | Sensor |1 | ------> | | (topic-s) |  --->  | Kafka |                       | | 
||   --------   |         | |           |         -------         -------------  | |      
||       8      |         | |    MQTT   |         4  |           |  Cassandra/ | | |
||  ----------  |    7    | |           |   6   ----------   5   | MySQL/File/ | | |
|| | Actuator | | <------ | | (topic-a) | <--- | Faust App| ---> |    None     | | |
||  ----------  |         |  -----------        ----------        -------------  | |
| --------------           ------------------------------------------------------  |
 ----------------------------------------------------------------------------------
```

Here is the description of each step:
1. Generate sensor data (synthetic). 
2. Publish generated data to an MQTT topic.
3. Get data from the MQTT topic and send it to the Kafka topic.
4. Consume the data from the Kafka topic and analyze it in real-time.
5. Save the data to Cassandra/File/None.
6. Publish the action generated by the analysis step to the MQTT topic.
7. Take care of the generated action.

### Prerequisites
- Kubernetes 1.12+
- A folder named /opt/data should exist with proper permissions for retaining generated data. 

## Installation/Deployment Steps
1. Create a namespace:
```shell
kubectl create namespace uc2
```

2. Add MQTT helm repo and deploy it:
```shell
helm repo add t3n https://storage.googleapis.com/t3n-helm-charts
helm -n uc2 upgrade --install mqtt -f mqtt-broker/mqtt-values.yaml t3n/mosquitto
```

<!-- 
Deploy mqtt-stresser:
```shell
kubectl apply -f -n uc2 mqtt-stresser/mqtt-stresser-pod.yaml
```
-->

3. Add Kafka helm repo and deploy it:
```shell
helm repo add bitnami https://charts.bitnami.com/bitnami
helm upgrade --install bitnami -n uc2 -f kafka-broker/kafka-values.yaml bitnami/kafka
```

4. Add Cassandra helm repo and deploy it:
```shell
helm repo add bitnami https://charts.bitnami.com/bitnami
helm upgrade --install cassandra -n=uc2 -f datastores/cassandra-values.yaml bitnami/cassandra
```

5. Deploy synthetic data generator (Job):
```shell
kubectl apply -n uc2 -f kubernetes/data-generator-job.yaml
```

6. Deploy MQTT Publisher to send generated values to MQTT broker (anyone or more options can be selected):
```shell
kubectl apply -n uc2 -f kubernetes/publisher-deployment-normal.yaml #Deploy 10 normal sensors with fixed message delay as pods
kubectl apply -n uc2 -f kubernetes/publisher-deployment-abnormal.yaml #Deploy 1 abnormal sensor with fixed message delay as a pod
kubectl apply -n uc2 -f kubernetes/publisher-deployment-mixed.yaml #Deploy 1 sensor with mixed data at random message delay as a pod
```

7. Deploy MQTT Subscriber and Kafka Producer:
```shell
kubectl apply -n uc2 -f kubernetes/subscriber-deployment.yaml
```

8. Deploy Kafka Consumer and Faust streaming analysis application:
```shell
kubectl apply -n uc2 -f kubernetes/temp-analyzer-deployment.yaml
```

9. Deploy actuator to read actions from MQTT:
```shell
kubectl apply -n uc2 -f kubernetes/temp-actuator-pod.yaml
```

## Parameters Description (Need to be updated)
#### Common parameters for all services
| Name                | Description                                                | Default value                                                     |
|:--------------------|:-----------------------------------------------------------|:------------------------------------------------------------------|
| `MQTT_BROKER`       | MQTT broker address.                                       | mqtt-mosquitto.uc2.svc.cluster.local                              |
| `MQTT_BROKER_PORT`  | MQTT broker port.                                          | 1883                                                              |
| `MQTT_SENSOR_TOPIC` | MQTT topic for sending generated data by Sensor.           | mqtt/temperature/readings                                         |
| `KAFKA_BROKER`      | Kafka broker address.                                      | bitnami-kafka-0.bitnami-kafka-headless.uc2.svc.cluster.local:9092 |
| `KAFKA_TOPIC`       | Kafka topic for sending generated data by MQTT Subscriber. | temperature-readings                                              |
| `VALUE_TYPE`        | Generated data value type.                                 | float                                                             |
| `INVALID_VALUE`     | Invalid value to introduce into generated data.            | 200.0                                                             |


#### Publisher service specific parameters
| Name                       | Description                                        | Default value |
|:---------------------------|:---------------------------------------------------|:--------------|
| `SENSORS`                  | Number of threads to start generating sensor data. | 1             | 
| `MESSAGE_DELAY`            | Delay between consecutive data points (sec).       | 0.5           |
| `START_VALUE`              | Generated data value start range.                  | 1.0           |
| `END_VALUE`                | Generated data value end range.                    | 99.99         |
| `INVALID_VALUE_OCCURRENCE` | Invalid value occurrence frequency.                | 100           |

#### Subscriber service specific parameters
| Name                       | Description                                                | Default value                                                     |
|:---------------------------|:-----------------------------------------------------------|:------------------------------------------------------------------|
| `KAFKA_TOPIC`              | Kafka topic for sending generated data by MQTT Subscriber. | temperature-readings                                              |

#### Analyzer service specific parameters
| Name                  | Description                                   | Default value            |
|:----------------------|:----------------------------------------------|:-------------------------|
| `MQTT_ACTUATOR_TOPIC` | MQTT topic for sending actions from Analyzer. | mqtt/temperature/actions |
| `MIN_THRESHOLD_VALUE` | Minimum threshold value for action creation.  | 10.0                     |
| `MAX_THRESHOLD_VALUE` | Maximum threshold value for action creation.  | 90.0                     |
| `SAVE_DATA`           | Save data to cassandra/file/none.             | file                     |

#### Actuator service specific parameters
| Name                       | Description                                                | Default value                                                     |
|:---------------------------|:-----------------------------------------------------------|:------------------------------------------------------------------|
| `MQTT_ACTUATOR_TOPIC`      | MQTT topic for sending actions from Analyzer.              | mqtt/temperature/actions                                          |

### Reading resources about MQTT and MQTT Stresser

[MQTT-Stresser](https://github.com/flaviostutz/mqtt-stresser)

[MQTT](https://github.com/t3n/helm-charts/tree/master/mosquitto)